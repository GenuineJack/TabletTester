<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablet Tester - Advanced PDF Testing Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
        }

        /* Footer Styles */
        .footer {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 24px 16px;
            text-align: center;
            margin-top: 40px;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
        }

        .footer a {
            color: #6366f1;
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .pizza-button {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white !important;
            padding: 8px 20px;
            border-radius: 20px;
            text-decoration: none !important;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .pizza-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            text-decoration: none !important;
        }

        /* Screen Management */
        .screen {
            display: none;
            min-height: calc(100vh - 120px);
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Upload Screen */
        .app-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .drop-zone {
            background: white;
            border: 3px dashed #e5e7eb;
            border-radius: 20px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        @media (min-width: 768px) {
            .drop-zone {
                padding: 60px 40px;
            }
        }

        .drop-zone:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .drop-zone.drag-over {
            border-color: #6366f1;
            background: #f0f9ff;
        }

        .upload-icon {
            display: flex;
            justify-content: center;
            animation: pulse 2s ease-in-out infinite;
            margin-bottom: 24px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .browse-button {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            padding: 12px 32px;
            border-radius: 30px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .browse-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        /* Loading Screen */
        #loadingScreen {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        #loadingScreen.active {
            display: flex;
        }

        .loading-container {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .tablet-loader {
            width: 120px;
            height: 160px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            margin: 0 auto 40px;
            position: relative;
            animation: tilt 2s ease-in-out infinite;
        }

        @keyframes tilt {
            0%, 100% {
                transform: rotate(-3deg);
            }
            50% {
                transform: rotate(3deg);
            }
        }

        .loading-message {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .loading-message {
                font-size: 1.5rem;
            }
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Main Preview Section */
        .main-preview-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .main-preview-section {
                padding: 40px;
            }
        }

        .main-tablet-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: min-height 0.3s ease;
            padding: 20px 0;
        }

        .main-tablet-frame {
            background: #1a1a1a;
            border-radius: 36px;
            padding: 20px;
            position: relative;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 100%;
        }

        .tablet-screen {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .pdf-viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        .pdf-viewer-container.grabbing {
            cursor: grabbing;
        }

        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            transform-origin: top left;
            transition: transform 0.1s ease-out;
        }

        /* Preview Controls */
        .preview-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
            flex-wrap: wrap;
            max-width: 300px;
        }

        @media (min-width: 768px) {
            .preview-controls {
                top: 20px;
                right: 20px;
                gap: 10px;
                max-width: none;
            }
        }

        .control-button {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #374151;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 768px) {
            .control-button {
                padding: 8px 12px;
                gap: 6px;
                font-size: 14px;
            }
        }

        .control-button:hover {
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .control-button.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border-radius: 12px;
            padding: 6px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .zoom-controls {
                bottom: 20px;
                gap: 10px;
                padding: 8px 16px;
            }
        }

        .zoom-slider {
            width: 100px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        @media (min-width: 768px) {
            .zoom-slider {
                width: 150px;
            }
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
        }

        .zoom-percentage {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            min-width: 50px;
            text-align: center;
        }

        .zoom-percentage.warning {
            color: #ef4444;
        }

        /* Enhanced PDF Annotation Modal */
        .pdf-annotation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .pdf-annotation-modal.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }

        .pdf-annotation-header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pdf-annotation-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-right: auto;
        }

        .pdf-close-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .pdf-close-button:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .pdf-toolbar {
            background: white;
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-divider {
            width: 1px;
            height: 32px;
            background: #e5e7eb;
            margin: 0 8px;
        }

        .pdf-annotation-content {
            flex: 1;
            display: flex;
            background: #f8fafc;
            overflow: hidden;
        }

        .pdf-viewer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .pdf-controls {
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .page-navigation {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-nav-button {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
        }

        .page-nav-button:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }

        .page-nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: #6b7280;
            min-width: 120px;
            text-align: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-button {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
        }

        .zoom-button:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }

        .zoom-display {
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            color: #374151;
        }

        .pdf-canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .pdf-page-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .pdf-canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .pdf-annotation-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .pdf-annotation-layer.active {
            pointer-events: all;
            cursor: crosshair;
        }

        .pdf-annotation-box {
            position: absolute;
            border: 2px solid;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(1px);
            pointer-events: all;
            cursor: move;
            min-width: 20px;
            min-height: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: box-shadow 0.2s ease;
        }

        .pdf-annotation-box:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .pdf-annotation-box.selected {
            border-style: dashed;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        .pdf-annotation-text {
            position: absolute;
            bottom: -35px;
            left: 0;
            background: white;
            border: 1px solid;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            word-wrap: break-word;
            white-space: normal;
        }

        .pdf-annotation-input {
            position: absolute;
            bottom: -35px;
            left: 0;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            min-width: 150px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
        }

        .pdf-annotation-footer {
            background: white;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
        }

        .annotations-sidebar {
            width: 300px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .annotation-list-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .annotation-list-item:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
        }

        .annotation-list-item.active {
            background: #ede9fe;
            border-color: #6366f1;
        }

        .annotation-page-badge {
            display: inline-block;
            background: #6366f1;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .annotation-text-preview {
            font-size: 14px;
            color: #374151;
            line-height: 1.4;
        }

        .annotation-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        /* Color Selector Styles */
        .color-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: #374151;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
        }

        .custom-color-input {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        /* Toolbar Enhancements */
        .annotation-mode-toggle {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
        }

        .annotation-mode-toggle:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }

        .annotation-mode-toggle.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .action-button {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }

        .action-button.danger {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-button.danger:hover {
            background: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }

        /* Temporary annotation styling */
        #temp-pdf-annotation {
            position: absolute;
            border: 2px dashed;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 5;
        }

        /* Responsive design for PDF modal */
        @media (max-width: 1024px) {
            .annotations-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .pdf-toolbar {
                padding: 8px 16px;
                gap: 8px;
            }
            
            .pdf-viewer-container {
                margin: 10px;
            }
            
            .pdf-annotation-header {
                padding: 12px 16px;
            }
            
            .pdf-annotation-footer {
                padding: 12px 16px;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Smart Recommendations */
        .recommendations-panel {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .recommendation-item {
            display: flex;
            align-items: start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .recommendation-item:last-child {
            margin-bottom: 0;
        }

        .recommendation-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 12px;
            color: white;
        }

        .recommendation-icon.tip {
            background: #3b82f6;
        }

        .recommendation-icon.warning {
            background: #f59e0b;
        }

        .recommendation-icon.error {
            background: #ef4444;
        }

        .recommendation-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        /* Summary Section */
        .summary-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .summary-card {
                padding: 32px;
            }
        }

        .summary-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .summary-filters {
                display: flex;
                justify-content: center;
                gap: 24px;
            }
        }

        .summary-item {
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .summary-item {
                padding: 12px 24px;
            }
        }

        .summary-item:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .summary-item.active {
            background: #ede9fe;
            border: 2px solid #6366f1;
        }

        /* Device Grid */
        .device-grid-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        @media (min-width: 768px) {
            .device-grid-section {
                padding: 40px;
            }
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        @media (min-width: 768px) {
            .device-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 24px;
            }
        }

        .device-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .device-card {
                padding: 20px;
            }
        }

        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .device-card.selected {
            background: #ede9fe;
            border: 2px solid #6366f1;
        }

        .device-card.filtered-out {
            opacity: 0.3;
            pointer-events: none;
        }

        .mini-tablet {
            width: 60px;
            height: 75px;
            background: #2a2a2a;
            border-radius: 8px;
            margin: 0 auto 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        @media (min-width: 768px) {
            .mini-tablet {
                width: 80px;
                height: 100px;
                border-radius: 12px;
            }
        }

        .mini-tablet.landscape {
            width: 75px;
            height: 60px;
        }

        @media (min-width: 768px) {
            .mini-tablet.landscape {
                width: 100px;
                height: 80px;
            }
        }

        .mini-tablet-screen {
            width: calc(100% - 8px);
            height: calc(100% - 8px);
            background: #e5e7eb;
            border-radius: 4px;
        }

        @media (min-width: 768px) {
            .mini-tablet-screen {
                border-radius: 8px;
            }
        }

        .rotate-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(99, 102, 241, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .device-card:hover .rotate-button {
            opacity: 1;
        }

        .device-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .device-specs {
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .device-specs {
                font-size: 0.75rem;
            }
        }

        .device-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Performance Indicators */
        .performance-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-top: 8px;
        }

        @media (min-width: 768px) {
            .performance-badge {
                font-size: 0.75rem;
            }
        }

        .performance-fast {
            background: #d1fae5;
            color: #065f46;
        }

        .performance-moderate {
            background: #fed7aa;
            color: #92400e;
        }

        .performance-slow {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Indicators */
        .indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
        }

        @media (min-width: 768px) {
            .indicator {
                width: 20px;
                height: 20px;
            }
        }

        .indicator-success {
            background: #10b981;
        }

        .indicator-warning {
            background: #f59e0b;
        }

        .indicator-error {
            background: #ef4444;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            margin-bottom: 8px;
            max-width: 250px;
            white-space: normal;
            text-align: left;
            z-index: 20;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }

        .device-card:hover .tooltip {
            opacity: 1;
        }

        /* Device Switcher */
        .device-switcher {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }

        @media (min-width: 768px) {
            .device-switcher {
                top: 20px;
                left: 20px;
            }
        }

        .device-dropdown {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            min-width: 150px;
        }

        @media (min-width: 768px) {
            .device-dropdown {
                padding: 8px 16px;
                font-size: 14px;
                min-width: 200px;
            }
        }

        /* Export Panel */
        .export-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
        }

        .export-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-button {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
        }

        .export-button:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }

        /* PDF Analysis Panel */
        .pdf-analysis-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .analysis-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .analysis-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
        }

        .analysis-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Responsive Design */
        @media (max-width: 767px) {
            .text-5xl {
                font-size: 2.25rem;
            }
            
            .text-2xl {
                font-size: 1.5rem;
            }
            
            .text-xl {
                font-size: 1.125rem;
            }
            
            .text-lg {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <!-- Screen 1: Upload Screen -->
        <div id="uploadScreen" class="screen active">
            <div class="container mx-auto px-4 py-8 md:py-12 max-w-4xl">
                <header class="text-center mb-8 md:mb-12">
                    <div class="flex justify-center mb-6">
                        <div class="app-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="5" y="2" width="14" height="20" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M9 6H15M9 10H15M9 14H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-gray-900 mb-4">Tablet Tester</h1>
                    <p class="text-lg md:text-xl text-gray-600 max-w-2xl mx-auto">
                        Advanced PDF testing across 25+ tablet devices. Test compatibility, interactivity, and performance with professional tools.
                    </p>
                </header>

                <div class="upload-container max-w-xl mx-auto">
                    <div id="dropZone" class="drop-zone">
                        <input type="file" id="fileInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="upload-content">
                            <div class="upload-icon">
                                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15L12 3M12 3L16 7M12 3L8 7" stroke="url(#gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M2 17L2 19C2 20.1046 2.89543 21 4 21L20 21C21.1046 21 22 20.1046 22 19L22 17" stroke="url(#gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" stop-color="#6366f1"/>
                                            <stop offset="100%" stop-color="#a855f7"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                            </div>
                            <h3 class="text-xl md:text-2xl font-semibold text-gray-800 mb-2">Drop your PDF here</h3>
                            <p class="text-gray-600 mb-4">or click to browse your files</p>
                            <button class="browse-button" type="button" id="browseButton">Choose PDF</button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 md:mt-12 text-center">
                    <p class="text-sm text-gray-500 mb-4">Enhanced Analysis Features</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 max-w-2xl mx-auto text-xs md:text-sm">
                        <div class="flex items-center gap-2 justify-center">
                            <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Real PDF dimensions</span>
                        </div>
                        <div class="flex items-center gap-2 justify-center">
                            <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Content complexity analysis</span>
                        </div>
                        <div class="flex items-center gap-2 justify-center">
                            <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Dynamic compatibility</span>
                        </div>
                        <div class="flex items-center gap-2 justify-center">
                            <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>PDF annotation tools</span>
                        </div>
                        <div class="flex items-center gap-2 justify-center">
                            <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Performance optimization</span>
                        </div>
                        <div class="flex items-center gap-2 justify-center">
                            <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Smart recommendations</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Interstitial -->
        <div id="loadingScreen" class="screen">
            <div class="loading-container">
                <div class="loading-animation">
                    <div class="tablet-loader">
                        <div class="tablet-screen-loader"></div>
                    </div>
                </div>
                <h2 id="loadingMessage" class="loading-message">Analyzing your PDF's DNA...</h2>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Screen 2: Preview Screen -->
        <div id="previewScreen" class="screen">
            <div class="container mx-auto px-4 py-6 md:py-8 max-w-7xl">
                <!-- Header -->
                <header class="flex items-center justify-between mb-6 md:mb-8">
                    <button id="backButton" class="back-button flex items-center gap-2 px-3 py-2 md:px-4 md:py-2 text-indigo-600 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        <span class="hidden sm:inline">New PDF</span>
                    </button>
                    <div class="text-center flex-1">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900">PDF Testing Suite</h2>
                        <p id="pdfName" class="text-xs md:text-sm text-gray-600 mt-1 truncate max-w-xs mx-auto"></p>
                    </div>
                    <div class="w-16 md:w-24"></div>
                </header>

                <!-- PDF Analysis Overview -->
                <div class="pdf-analysis-panel">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">PDF Analysis Overview</h3>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div id="pdfPages" class="analysis-value">-</div>
                            <div class="analysis-label">Pages</div>
                        </div>
                        <div class="analysis-item">
                            <div id="pdfDimensions" class="analysis-value">-</div>
                            <div class="analysis-label">Dimensions</div>
                        </div>
                        <div class="analysis-item">
                            <div id="pdfFileSize" class="analysis-value">-</div>
                            <div class="analysis-label">File Size</div>
                        </div>
                        <div class="analysis-item">
                            <div id="pdfComplexity" class="analysis-value">-</div>
                            <div class="analysis-label">Complexity</div>
                        </div>
                        <div class="analysis-item">
                            <div id="pdfTextContent" class="analysis-value">-</div>
                            <div class="analysis-label">Text Heavy</div>
                        </div>
                        <div class="analysis-item">
                            <div id="pdfOrientation" class="analysis-value">-</div>
                            <div class="analysis-label">Orientation</div>
                        </div>
                    </div>
                </div>

                <!-- Main Preview -->
                <div class="main-preview-section mb-8 md:mb-12" id="mainPreviewSection">
                    <!-- Device Switcher -->
                    <div class="device-switcher">
                        <select id="deviceSelector" class="device-dropdown">
                            <option value="0">iPad Pro 12.9"</option>
                        </select>
                    </div>

                    <!-- Preview Controls -->
                    <div class="preview-controls">
                        <button id="rotateMainBtn" class="control-button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 2v6h-6M3 12a9 9 0 0 1 15.364-6.364L21 8.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="hidden sm:inline">Rotate</span>
                        </button>
                        <button id="annotateBtn" class="control-button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-width="2"/>
                            </svg>
                            <span class="hidden sm:inline">Annotate PDF</span>
                        </button>
                    </div>

                    <div class="main-tablet-container" id="mainTabletContainer">
                        <div id="mainTablet" class="main-tablet-frame">
                            <div class="tablet-screen">
                                <div class="pdf-viewer-container" id="pdfContainer">
                                    <iframe id="mainPdfViewer" class="pdf-viewer"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zoom Controls -->
                    <div class="zoom-controls">
                        <button id="zoomOut" class="control-button" style="padding: 4px 8px;">-</button>
                        <input type="range" id="zoomSlider" class="zoom-slider" min="50" max="200" value="100">
                        <span id="zoomPercentage" class="zoom-percentage">100%</span>
                        <button id="zoomIn" class="control-button" style="padding: 4px 8px;">+</button>
                        <button id="resetZoom" class="control-button" style="padding: 4px 8px;">Reset</button>
                    </div>
                </div>

                <!-- Smart Recommendations -->
                <div id="recommendationsPanel" class="recommendations-panel">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Smart Recommendations</h3>
                    <div id="recommendationsList"></div>
                </div>

                <!-- Summary Stats -->
                <div class="summary-section">
                    <div class="summary-card">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Compatibility Summary</h4>
                        <div class="summary-filters">
                            <div class="summary-item" data-filter="all">
                                <div class="text-2xl md:text-3xl font-bold text-gray-600">25</div>
                                <div class="text-xs md:text-sm text-gray-600">All Devices</div>
                            </div>
                            <div class="summary-item" data-filter="excellent">
                                <div id="excellentCount" class="text-2xl md:text-3xl font-bold text-green-600">0</div>
                                <div class="text-xs md:text-sm text-gray-600">Excellent</div>
                            </div>
                            <div class="summary-item" data-filter="good">
                                <div id="goodCount" class="text-2xl md:text-3xl font-bold text-yellow-600">0</div>
                                <div class="text-xs md:text-sm text-gray-600">Good</div>
                            </div>
                            <div class="summary-item" data-filter="issues">
                                <div id="issuesCount" class="text-2xl md:text-3xl font-bold text-red-600">0</div>
                                <div class="text-xs md:text-sm text-gray-600">Has Issues</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Grid -->
                <div class="device-grid-section">
                    <div class="flex items-center justify-between mb-4 md:mb-6">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-800">Device Compatibility Check</h3>
                        <div class="hidden sm:flex gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="indicator indicator-success"></span>
                                <span class="text-gray-600">Excellent</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="indicator indicator-warning"></span>
                                <span class="text-gray-600">Good</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="indicator indicator-error"></span>
                                <span class="text-gray-600">Issues</span>
                            </div>
                        </div>
                    </div>

                    <div id="deviceGrid" class="device-grid">
                        <!-- Devices will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Export Options -->
                <div class="export-panel">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Export Options</h4>
                    <div class="export-options">
                        <button class="export-button" id="exportAllBtn">
                            📱 Export All Device Screenshots
                        </button>
                        <button class="export-button" id="exportReportBtn">
                            📊 Export Detailed Analysis Report (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced PDF Annotation Modal -->
        <div id="pdfAnnotationModal" class="pdf-annotation-modal">
            <!-- Header -->
            <div class="pdf-annotation-header">
                <h3 class="pdf-annotation-title">PDF Annotation Tool</h3>
                <span id="pdfFileName" class="text-sm text-gray-600 mx-4"></span>
                <button id="closePdfAnnotationBtn" class="pdf-close-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="18" y1="6" x2="6" y2="18" stroke-width="2"/>
                        <line x1="6" y1="6" x2="18" y2="18" stroke-width="2"/>
                    </svg>
                </button>
            </div>
            
            <!-- Toolbar -->
            <div class="pdf-toolbar">
                <div class="toolbar-group">
                    <button id="annotationModeToggle" class="annotation-mode-toggle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-width="2"/>
                        </svg>
                        Start Annotating
                    </button>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <div class="toolbar-group">
                    <span class="text-sm text-gray-600">Color:</span>
                    <div class="color-selector">
                        <div class="color-option active" data-color="#ef4444" style="background: #ef4444;"></div>
                        <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;"></div>
                        <div class="color-option" data-color="#10b981" style="background: #10b981;"></div>
                        <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
                        <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
                        <input type="color" id="customColorInput" class="custom-color-input" value="#ef4444">
                    </div>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <div class="toolbar-group">
                    <button id="clearAllPdfAnnotations" class="action-button" style="padding: 6px 12px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polyline points="3,6 5,6 21,6" stroke-width="2"/>
                            <path d="M19,6v14a2,2 0 01-2,2H7a2,2 0 01-2-2V6m3,0V4a2,2 0 012-2h4a2,2 0 012,2v2" stroke-width="2"/>
                        </svg>
                        Clear All
                    </button>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="pdf-annotation-content">
                <!-- PDF Viewer -->
                <div class="pdf-viewer-container">
                    <!-- PDF Controls -->
                    <div class="pdf-controls">
                        <div class="page-navigation">
                            <button id="prevPageBtn" class="page-nav-button">← Previous</button>
                            <span id="pageInfo" class="page-info">Page 1 of 1</span>
                            <button id="nextPageBtn" class="page-nav-button">Next →</button>
                        </div>
                        
                        <div class="zoom-controls">
                            <button id="zoomOutBtn" class="zoom-button">-</button>
                            <span id="zoomDisplay" class="zoom-display">100%</span>
                            <button id="zoomInBtn" class="zoom-button">+</button>
                            <button id="resetZoomBtn" class="zoom-button">Reset</button>
                        </div>
                    </div>
                    
                    <!-- PDF Canvas Area -->
                    <div class="pdf-canvas-container" id="pdfCanvasContainer">
                        <div class="pdf-page-wrapper" id="pdfPageWrapper">
                            <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
                            <div id="pdfAnnotationLayer" class="pdf-annotation-layer"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Annotations Sidebar -->
                <div class="annotations-sidebar">
                    <div class="sidebar-header">
                        <h4 class="font-semibold text-gray-800">Annotations</h4>
                        <p class="text-sm text-gray-600 mt-1">Click annotations to navigate</p>
                    </div>
                    <div class="sidebar-content" id="annotationsList">
                        <div class="text-center text-gray-500 py-8">
                            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            <p>No annotations yet</p>
                            <p class="text-xs mt-1">Start annotating to see them here</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="pdf-annotation-footer">
                <button class="action-button" id="exportPdfWithAnnotations">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke-width="2"/>
                    </svg>
                    Export Annotated PDF
                </button>
                <button class="action-button" id="exportAnnotationReport">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 19c-5 0-8-3-8-8s3-8 8-8 8 3 8 8-3 8-8 8z" stroke-width="2"/>
                        <path d="M20 20l-4.35-4.35" stroke-width="2"/>
                    </svg>
                    Export Report (CSV)
                </button>
                <button class="action-button danger" id="closePdfModal">
                    Close
                </button>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div>
                Made with 🧡 by Jack
            </div>
            <a href="https://coff.ee/genuinejack" target="_blank" class="pizza-button">
                🍕 Buy me some pizza
            </a>
        </div>
    </footer>

    <script>
        // Tablet device data with enhanced specifications
        const tablets = [
            // Apple iPads
            { brand: 'Apple', name: 'iPad Pro 12.9"', width: 1024, height: 1366, ppi: 264, performance: 'fast', scale: 0.8, ram: 8, storage: 128, processor: 'M2' },
            { brand: 'Apple', name: 'iPad Pro 11"', width: 834, height: 1194, ppi: 264, performance: 'fast', scale: 0.65, ram: 8, storage: 128, processor: 'M2' },
            { brand: 'Apple', name: 'iPad Air 10.9"', width: 820, height: 1180, ppi: 264, performance: 'fast', scale: 0.64, ram: 8, storage: 64, processor: 'M1' },
            { brand: 'Apple', name: 'iPad 10.2"', width: 810, height: 1080, ppi: 264, performance: 'moderate', scale: 0.63, ram: 3, storage: 64, processor: 'A13' },
            { brand: 'Apple', name: 'iPad mini 8.3"', width: 744, height: 1133, ppi: 326, performance: 'fast', scale: 0.58, ram: 4, storage: 64, processor: 'A15' },
            
            // Samsung Galaxy Tabs
            { brand: 'Samsung', name: 'Galaxy Tab S9 Ultra', width: 1848, height: 2960, ppi: 266, performance: 'fast', scale: 0.9, ram: 12, storage: 256, processor: 'Snapdragon 8 Gen 2' },
            { brand: 'Samsung', name: 'Galaxy Tab S9+', width: 1752, height: 2800, ppi: 266, performance: 'fast', scale: 0.85, ram: 8, storage: 128, processor: 'Snapdragon 8 Gen 2' },
            { brand: 'Samsung', name: 'Galaxy Tab S9', width: 1600, height: 2560, ppi: 274, performance: 'fast', scale: 0.8, ram: 8, storage: 128, processor: 'Snapdragon 8 Gen 2' },
            { brand: 'Samsung', name: 'Galaxy Tab A8', width: 800, height: 1280, ppi: 216, performance: 'moderate', scale: 0.5, ram: 3, storage: 32, processor: 'Unisoc Tiger T618' },
            { brand: 'Samsung', name: 'Galaxy Tab S6 Lite', width: 800, height: 1280, ppi: 224, performance: 'moderate', scale: 0.5, ram: 4, storage: 64, processor: 'Exynos 9611' },
            
            // Amazon Fire
            { brand: 'Amazon', name: 'Fire HD 10 Plus', width: 1200, height: 1920, ppi: 224, performance: 'moderate', scale: 0.7, ram: 4, storage: 32, processor: 'MediaTek MT8183' },
            { brand: 'Amazon', name: 'Fire HD 8 Plus', width: 800, height: 1280, ppi: 189, performance: 'moderate', scale: 0.5, ram: 3, storage: 32, processor: 'MediaTek MT8168' },
            { brand: 'Amazon', name: 'Fire HD 10', width: 1200, height: 1920, ppi: 224, performance: 'slow', scale: 0.7, ram: 3, storage: 32, processor: 'MediaTek MT8183' },
            { brand: 'Amazon', name: 'Fire HD 8', width: 800, height: 1280, ppi: 189, performance: 'slow', scale: 0.5, ram: 2, storage: 32, processor: 'MediaTek MT8168' },
            { brand: 'Amazon', name: 'Fire 7', width: 600, height: 1024, ppi: 171, performance: 'slow', scale: 0.4, ram: 1, storage: 16, processor: 'MediaTek MT8163' },
            
            // Microsoft Surface
            { brand: 'Microsoft', name: 'Surface Pro 9', width: 1920, height: 2880, ppi: 267, performance: 'fast', scale: 0.85, ram: 8, storage: 128, processor: 'Intel i5' },
            { brand: 'Microsoft', name: 'Surface Go 3', width: 1200, height: 1920, ppi: 220, performance: 'moderate', scale: 0.7, ram: 4, storage: 64, processor: 'Intel Pentium' },
            { brand: 'Microsoft', name: 'Surface Pro 8', width: 1920, height: 2880, ppi: 267, performance: 'fast', scale: 0.85, ram: 8, storage: 128, processor: 'Intel i5' },
            { brand: 'Microsoft', name: 'Surface Pro X', width: 1920, height: 2880, ppi: 267, performance: 'fast', scale: 0.85, ram: 8, storage: 128, processor: 'Microsoft SQ2' },
            { brand: 'Microsoft', name: 'Surface Go 2', width: 1200, height: 1920, ppi: 220, performance: 'moderate', scale: 0.7, ram: 4, storage: 64, processor: 'Intel Core m3' },
            
            // Lenovo Tabs
            { brand: 'Lenovo', name: 'Tab P12 Pro', width: 1600, height: 2560, ppi: 240, performance: 'fast', scale: 0.8, ram: 8, storage: 128, processor: 'Snapdragon 870' },
            { brand: 'Lenovo', name: 'Tab P11 Plus', width: 1200, height: 2000, ppi: 243, performance: 'moderate', scale: 0.7, ram: 4, storage: 64, processor: 'MediaTek Helio G90T' },
            { brand: 'Lenovo', name: 'Tab M10 Plus', width: 1200, height: 1920, ppi: 224, performance: 'moderate', scale: 0.7, ram: 4, storage: 64, processor: 'MediaTek Helio P22T' },
            { brand: 'Lenovo', name: 'Tab P11', width: 1200, height: 2000, ppi: 243, performance: 'moderate', scale: 0.7, ram: 4, storage: 64, processor: 'Snapdragon 662' },
            { brand: 'Lenovo', name: 'Tab M8', width: 800, height: 1280, ppi: 189, performance: 'slow', scale: 0.5, ram: 2, storage: 16, processor: 'MediaTek Helio A22' }
        ];

        // Enhanced loading messages for real analysis
        const loadingMessages = [
            "Analyzing your PDF's structure...",
            "Reading page dimensions and content...",
            "Calculating text complexity scores...",
            "Evaluating image and vector content...",
            "Testing device compatibility matrices...",
            "Generating performance predictions...",
            "Analyzing font sizes and readability...",
            "Computing layout optimization scores...",
            "Processing content density analysis...",
            "Finalizing compatibility report..."
        ];

        // Global state
        let currentPdfUrl = null;
        let pdfDimensions = { width: 612, height: 792 }; // This will be updated dynamically
        let pdfAnalysis = {}; // New: stores detailed PDF analysis
        let currentDevice = tablets[0];
        let currentDeviceIndex = 0;
        let currentZoom = 100;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let isPortrait = true;
        let fileSize = 0;
        let activeFilter = 'all';
        let deviceCompatibilities = [];
        let pdfArrayBuffer = null;
        
        // PDF and Annotation state
        let pdfDocument = null;
        let currentPageNumber = 1;
        let totalPages = 0;
        let pdfZoom = 1.0;
        let isAnnotationMode = false;
        let currentAnnotationColor = '#ef4444';
        let annotations = [];
        let currentAnnotation = null;
        let isDrawing = false;
        let isDraggingAnnotation = false;
        let dragOffset = { x: 0, y: 0 };

        // Initialize PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Enhanced PDF Analysis Function
        async function analyzePDF(arrayBuffer) {
            console.log('Starting enhanced PDF analysis...');
            
            try {
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;
                
                const analysis = {
                    pageCount: pdf.numPages,
                    totalTextLength: 0,
                    totalImages: 0,
                    totalVectors: 0,
                    minFontSize: Infinity,
                    maxFontSize: 0,
                    averageFontSize: 0,
                    contentDensity: 0,
                    hasComplexGraphics: false,
                    hasInteractiveElements: false,
                    pageDimensions: [],
                    aspectRatios: [],
                    textToImageRatio: 0,
                    complexityScore: 0
                };

                // Analyze a sample of pages (first 3 for performance)
                const pagesToAnalyze = Math.min(3, pdf.numPages);
                let totalFontSize = 0;
                let fontSizeCount = 0;

                for (let i = 1; i <= pagesToAnalyze; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.0 });
                    
                    // Store page dimensions
                    analysis.pageDimensions.push({
                        width: viewport.width,
                        height: viewport.height
                    });
                    
                    analysis.aspectRatios.push(viewport.width / viewport.height);

                    // Get text content
                    try {
                        const textContent = await page.getTextContent();
                        textContent.items.forEach(item => {
                            if (item.str && item.str.trim()) {
                                analysis.totalTextLength += item.str.length;
                                
                                // Analyze font sizes if available
                                if (item.height) {
                                    analysis.minFontSize = Math.min(analysis.minFontSize, item.height);
                                    analysis.maxFontSize = Math.max(analysis.maxFontSize, item.height);
                                    totalFontSize += item.height;
                                    fontSizeCount++;
                                }
                            }
                        });
                    } catch (e) {
                        console.warn('Could not extract text from page', i);
                    }

                    // Analyze graphics complexity
                    try {
                        const operatorList = await page.getOperatorList();
                        operatorList.fnArray.forEach((fn, index) => {
                            // Count images
                            if (fn === pdfjsLib.OPS.paintImageXObject || fn === pdfjsLib.OPS.paintJpegXObject) {
                                analysis.totalImages++;
                            }
                            // Count vector graphics
                            if (fn === pdfjsLib.OPS.constructPath || fn === pdfjsLib.OPS.stroke || fn === pdfjsLib.OPS.fill) {
                                analysis.totalVectors++;
                            }
                            // Check for interactive elements
                            if (fn === pdfjsLib.OPS.beginAnnotation) {
                                analysis.hasInteractiveElements = true;
                            }
                        });
                    } catch (e) {
                        console.warn('Could not analyze graphics for page', i);
                    }
                }

                // Calculate derived metrics
                analysis.averageFontSize = fontSizeCount > 0 ? totalFontSize / fontSizeCount : 12;
                if (analysis.minFontSize === Infinity) analysis.minFontSize = 10;
                
                // Set primary page dimensions (use first page)
                if (analysis.pageDimensions.length > 0) {
                    pdfDimensions.width = analysis.pageDimensions[0].width;
                    pdfDimensions.height = analysis.pageDimensions[0].height;
                }

                // Calculate complexity score (0-100)
                let complexityScore = 0;
                complexityScore += Math.min(analysis.totalImages * 5, 30); // Images add complexity
                complexityScore += Math.min(analysis.totalVectors / 100, 20); // Many vectors add complexity
                complexityScore += analysis.pageCount > 10 ? 15 : analysis.pageCount * 1.5; // Page count
                complexityScore += analysis.hasInteractiveElements ? 15 : 0; // Interactive elements
                complexityScore += analysis.averageFontSize < 10 ? 10 : 0; // Small fonts
                complexityScore += analysis.totalTextLength > 50000 ? 10 : analysis.totalTextLength / 5000; // Text density
                
                analysis.complexityScore = Math.min(100, complexityScore);
                analysis.hasComplexGraphics = analysis.totalImages > 5 || analysis.totalVectors > 1000;
                analysis.contentDensity = analysis.totalTextLength / pagesToAnalyze;
                analysis.textToImageRatio = analysis.totalImages > 0 ? analysis.totalTextLength / analysis.totalImages : analysis.totalTextLength;

                console.log('PDF Analysis completed:', analysis);
                return analysis;

            } catch (error) {
                console.error('Error analyzing PDF:', error);
                // Return default analysis if there's an error
                return {
                    pageCount: 1,
                    totalTextLength: 1000,
                    totalImages: 1,
                    totalVectors: 100,
                    minFontSize: 10,
                    maxFontSize: 14,
                    averageFontSize: 12,
                    contentDensity: 1000,
                    hasComplexGraphics: false,
                    hasInteractiveElements: false,
                    pageDimensions: [{ width: 612, height: 792 }],
                    aspectRatios: [0.77],
                    textToImageRatio: 1000,
                    complexityScore: 30
                };
            }
        }

        // Enhanced compatibility calculation using real PDF data
        function calculateEnhancedCompatibility(tablet) {
            if (!pdfAnalysis || Object.keys(pdfAnalysis).length === 0) {
                // Fallback to basic calculation if analysis isn't available
                return calculateBasicCompatibility(tablet);
            }

            const pdfAspectRatio = pdfDimensions.width / pdfDimensions.height;
            const tabletAspectRatio = tablet.width / tablet.height;
            
            // Calculate scale factor for optimal viewing
            let scaleFactor;
            if (pdfAspectRatio > tabletAspectRatio) {
                scaleFactor = tablet.width / pdfDimensions.width;
            } else {
                scaleFactor = tablet.height / pdfDimensions.height;
            }
            
            // Calculate effective text size based on PDF's actual font sizes
            const averageTextSize = pdfAnalysis.averageFontSize * scaleFactor;
            const minTextSize = pdfAnalysis.minFontSize * scaleFactor;
            
            // Base performance score from device capabilities
            let performanceScore = 10;
            if (tablet.performance === 'moderate') performanceScore = 7;
            if (tablet.performance === 'slow') performanceScore = 4;
            
            // Adjust based on device RAM and storage
            if (tablet.ram < 3) performanceScore -= 2;
            if (tablet.ram < 2) performanceScore -= 2;
            if (tablet.storage < 32) performanceScore -= 1;
            
            // File size impact
            const fileSizeMB = fileSize / (1024 * 1024);
            if (fileSizeMB > 10) performanceScore -= 1;
            if (fileSizeMB > 20) performanceScore -= 2;
            if (fileSizeMB > 50) performanceScore -= 3;
            
            // Content complexity impact
            if (pdfAnalysis.complexityScore > 70) performanceScore -= 2;
            if (pdfAnalysis.complexityScore > 90) performanceScore -= 2;
            if (pdfAnalysis.hasComplexGraphics) performanceScore -= 1;
            if (pdfAnalysis.hasInteractiveElements) performanceScore -= 1;
            
            // Page count impact
            if (pdfAnalysis.pageCount > 50) performanceScore -= 1;
            if (pdfAnalysis.pageCount > 100) performanceScore -= 2;
            
            // High-resolution content on low-PPI devices
            if (tablet.ppi < 200 && (pdfAnalysis.totalImages > 5 || pdfAnalysis.hasComplexGraphics)) {
                performanceScore -= 1;
            }
            
            // Device-specific adjustments
            if (tablet.brand === 'Amazon' && pdfAnalysis.complexityScore > 50) {
                performanceScore -= 1; // Fire tablets struggle with complex content
            }
            
            if (tablet.brand === 'Apple' && pdfAnalysis.hasInteractiveElements) {
                performanceScore += 1; // iPads handle interactive content well
            }

            // Ensure score doesn't go below 1
            performanceScore = Math.max(1, performanceScore);
            
            // Calculate readability score
            let readabilityScore = 10;
            if (minTextSize < 8) readabilityScore -= 3;
            if (minTextSize < 6) readabilityScore -= 3;
            if (averageTextSize < 10) readabilityScore -= 2;
            if (pdfAnalysis.contentDensity > 10000) readabilityScore -= 1; // Very dense text
            
            readabilityScore = Math.max(1, readabilityScore);
            
            // Determine overall status
            let status, message;
            const issues = [];
            
            const overallScore = (performanceScore + readabilityScore) / 2;
            
            if (overallScore >= 8 && averageTextSize >= 10 && scaleFactor >= 0.7) {
                status = 'excellent';
                message = `Perfect match! PDF renders beautifully with ${Math.round(averageTextSize)}pt text.`;
            } else if (overallScore >= 6 && averageTextSize >= 8 && scaleFactor >= 0.5) {
                status = 'good';
                message = `Good compatibility. Text size: ${Math.round(averageTextSize)}pt, minor optimizations recommended.`;
                if (pdfAnalysis.complexityScore > 70) issues.push('Complex graphics may slow rendering');
                if (fileSizeMB > 20) issues.push('Large file size may impact loading');
            } else {
                status = 'issues';
                if (averageTextSize < 8) issues.push(`Text too small (${Math.round(averageTextSize)}pt)`);
                if (scaleFactor < 0.5) issues.push('Significant zooming required');
                if (performanceScore < 5) issues.push('Performance issues likely');
                if (tablet.width < 800) issues.push('Limited screen space');
                if (pdfAnalysis.complexityScore > 80) issues.push('Very complex content');
                if (tablet.ram < 3 && fileSizeMB > 10) issues.push('Insufficient RAM for large file');
                
                message = issues.length > 0 ? issues.join('. ') + '.' : 'Various compatibility concerns detected.';
            }
            
            return {
                status,
                message,
                performanceScore,
                readabilityScore,
                scaleFactor,
                averageTextSize,
                minTextSize,
                overallScore: Math.round(overallScore),
                issues
            };
        }

        // Fallback function for basic compatibility (when PDF analysis fails)
        function calculateBasicCompatibility(tablet) {
            const pdfAspectRatio = pdfDimensions.width / pdfDimensions.height;
            const tabletAspectRatio = tablet.width / tablet.height;
            
            let scaleFactor;
            if (pdfAspectRatio > tabletAspectRatio) {
                scaleFactor = tablet.width / pdfDimensions.width;
            } else {
                scaleFactor = tablet.height / pdfDimensions.height;
            }
            
            const effectiveTextSize = 12 * scaleFactor;
            
            let performanceScore = 10;
            if (tablet.performance === 'moderate') performanceScore = 7;
            if (tablet.performance === 'slow') performanceScore = 5;
            
            const fileSizeMB = fileSize / (1024 * 1024);
            if (fileSizeMB > 10) performanceScore -= 2;
            if (fileSizeMB > 20) performanceScore -= 3;
            
            let status = 'good';
            let message = 'Basic compatibility analysis (detailed analysis unavailable).';
            
            if (effectiveTextSize < 8 || performanceScore < 5) {
                status = 'issues';
            } else if (effectiveTextSize >= 10 && performanceScore >= 8) {
                status = 'excellent';
            }
            
            return {
                status,
                message,
                performanceScore,
                scaleFactor,
                averageTextSize: effectiveTextSize,
                overallScore: performanceScore
            };
        }

        // Update PDF analysis display
        function updatePdfAnalysisDisplay() {
            if (!pdfAnalysis || Object.keys(pdfAnalysis).length === 0) return;
            
            document.getElementById('pdfPages').textContent = pdfAnalysis.pageCount || '-';
            document.getElementById('pdfDimensions').textContent = 
                `${Math.round(pdfDimensions.width)} × ${Math.round(pdfDimensions.height)}`;
            document.getElementById('pdfFileSize').textContent = 
                `${(fileSize / (1024 * 1024)).toFixed(1)}MB`;
            
            // Complexity assessment
            let complexityText = 'Low';
            if (pdfAnalysis.complexityScore > 40) complexityText = 'Medium';
            if (pdfAnalysis.complexityScore > 70) complexityText = 'High';
            if (pdfAnalysis.complexityScore > 90) complexityText = 'Very High';
            document.getElementById('pdfComplexity').textContent = complexityText;
            
            // Text content assessment
            const isTextHeavy = pdfAnalysis.textToImageRatio > 1000 || 
                              (pdfAnalysis.totalImages < 3 && pdfAnalysis.totalTextLength > 5000);
            document.getElementById('pdfTextContent').textContent = isTextHeavy ? 'Yes' : 'No';
            
            // Orientation
            const isLandscape = pdfDimensions.width > pdfDimensions.height;
            document.getElementById('pdfOrientation').textContent = isLandscape ? 'Landscape' : 'Portrait';
        }

        // Enhanced recommendations based on actual PDF analysis
        function generateEnhancedRecommendations() {
            const recommendationsList = document.getElementById('recommendationsList');
            const recommendations = [];
            const fileSizeMB = fileSize / (1024 * 1024);
            const device = currentDevice;
            const compatibility = calculateEnhancedCompatibility(device);
            
            // Device-specific recommendations
            if (device.width < 800) {
                recommendations.push({
                    type: 'warning',
                    text: `${device.name} has limited screen width (${device.width}px). Consider landscape orientation for better readability.`
                });
            }
            
            // Text size recommendations based on actual PDF fonts
            if (pdfAnalysis.minFontSize && compatibility.minTextSize < 8) {
                recommendations.push({
                    type: 'error',
                    text: `Smallest text will render at ${Math.round(compatibility.minTextSize)}pt on this device. Consider increasing font sizes in the original document.`
                });
            }
            
            if (pdfAnalysis.averageFontSize && compatibility.averageTextSize < 10) {
                recommendations.push({
                    type: 'warning',
                    text: `Average text size will be ${Math.round(compatibility.averageTextSize)}pt. Readability may be compromised on ${device.name}.`
                });
            }
            
            // Performance recommendations
            if (device.ram < 3 && pdfAnalysis.complexityScore > 60) {
                recommendations.push({
                    type: 'error',
                    text: `This device has limited RAM (${device.ram}GB). The complex content (score: ${Math.round(pdfAnalysis.complexityScore)}/100) may cause performance issues.`
                });
            }
            
            if (device.performance === 'slow' && fileSizeMB > 5) {
                recommendations.push({
                    type: 'warning',
                    text: `${device.name} has limited performance. Your ${fileSizeMB.toFixed(1)}MB PDF with ${pdfAnalysis.pageCount} pages may load slowly.`
                });
            }
            
            // Content-specific recommendations
            if (pdfAnalysis.hasComplexGraphics && device.ppi < 220) {
                recommendations.push({
                    type: 'tip',
                    text: `Your PDF contains complex graphics, but this device has lower resolution (${device.ppi}ppi). Graphics may appear less sharp.`
                });
            }
            
            if (pdfAnalysis.hasInteractiveElements) {
                if (device.brand === 'Apple') {
                    recommendations.push({
                        type: 'tip',
                        text: `Great! Your PDF has interactive elements and iPads handle these very well.`
                    });
                } else if (device.brand === 'Amazon') {
                    recommendations.push({
                        type: 'warning',
                        text: `Your PDF has interactive elements. Fire tablets may have limited support for PDF interactivity.`
                    });
                }
            }
            
            // File size and page count recommendations
            if (pdfAnalysis.pageCount > 50 && device.storage < 64) {
                recommendations.push({
                    type: 'warning',
                    text: `Large document (${pdfAnalysis.pageCount} pages) on device with limited storage (${device.storage}GB). Consider breaking into smaller sections.`
                });
            }
            
            // Aspect ratio recommendations
            const pdfAspect = pdfDimensions.width / pdfDimensions.height;
            const deviceAspect = device.width / device.height;
            if (Math.abs(pdfAspect - deviceAspect) > 0.3) {
                const recommendation = pdfAspect > deviceAspect ? 'landscape' : 'portrait';
                recommendations.push({
                    type: 'tip',
                    text: `PDF aspect ratio (${pdfAspect.toFixed(2)}) differs from device. Try ${recommendation} orientation for better fit.`
                });
            }
            
            // Content density recommendations
            if (pdfAnalysis.contentDensity > 8000) {
                recommendations.push({
                    type: 'warning',
                    text: `This PDF has very dense text content. Consider increasing line spacing or font size for better mobile readability.`
                });
            }
            
            // Success message for good compatibility
            if (compatibility.status === 'excellent') {
                recommendations.push({
                    type: 'tip',
                    text: `Excellent! Your PDF is well-optimized for ${device.name}. Text will be clear at ${Math.round(compatibility.averageTextSize)}pt average size.`
                });
            }
            
            recommendationsList.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item">
                    <div class="recommendation-icon ${rec.type}">
                        ${rec.type === 'tip' ? '💡' : rec.type === 'warning' ? '⚠️' : '❌'}
                    </div>
                    <div class="recommendation-text">${rec.text}</div>
                </div>
            `).join('');
            
            if (recommendations.length === 0) {
                recommendationsList.innerHTML = `
                    <div class="recommendation-item">
                        <div class="recommendation-icon tip">✅</div>
                        <div class="recommendation-text">No specific issues detected for ${device.name}.</div>
                    </div>
                `;
            }
        }

        // Setup PDF annotation mouse events
        function setupPdfAnnotationEvents() {
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            if (!annotationLayer) {
                console.error('PDF annotation layer not found');
                return;
            }
            
            // Remove any existing event listeners first
            removePdfAnnotationEvents();
            
            // Add event listeners for drawing annotations
            annotationLayer.addEventListener('mousedown', startPdfAnnotation);
            annotationLayer.addEventListener('mousemove', drawPdfAnnotation);
            annotationLayer.addEventListener('mouseup', finishPdfAnnotation);
            annotationLayer.addEventListener('mouseleave', finishPdfAnnotation);
            
            console.log('PDF annotation events set up successfully');
        }

        // Remove PDF annotation events
        function removePdfAnnotationEvents() {
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            if (!annotationLayer) return;
            
            annotationLayer.removeEventListener('mousedown', startPdfAnnotation);
            annotationLayer.removeEventListener('mousemove', drawPdfAnnotation);
            annotationLayer.removeEventListener('mouseup', finishPdfAnnotation);
            annotationLayer.removeEventListener('mouseleave', finishPdfAnnotation);
        }

        // Start drawing a PDF annotation
        function startPdfAnnotation(e) {
            if (!isAnnotationMode) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            const startX = e.clientX - rect.left;
            const startY = e.clientY - rect.top;
            
            currentAnnotation = {
                id: Date.now() + Math.random(),
                page: currentPageNumber,
                x: startX,
                y: startY,
                width: 0,
                height: 0,
                color: currentAnnotationColor,
                text: '',
                timestamp: new Date().toISOString()
            };
            
            isDrawing = true;
            console.log('Started drawing annotation at:', startX, startY);
        }

        // Draw the PDF annotation as user drags
        function drawPdfAnnotation(e) {
            if (!isDrawing || !currentAnnotation || !isAnnotationMode) return;
            
            e.preventDefault();
            
            const rect = e.currentTarget.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            // Calculate width and height
            const width = Math.abs(currentX - currentAnnotation.x);
            const height = Math.abs(currentY - currentAnnotation.y);
            
            // Adjust position if dragging left or up
            const x = Math.min(currentAnnotation.x, currentX);
            const y = Math.min(currentAnnotation.y, currentY);
            
            // Update annotation properties
            currentAnnotation.x = x;
            currentAnnotation.y = y;
            currentAnnotation.width = width;
            currentAnnotation.height = height;
            
            // Render the temporary annotation
            renderTemporaryPdfAnnotation();
        }

        // Finish drawing the PDF annotation
        function finishPdfAnnotation(e) {
            if (!isDrawing || !currentAnnotation) return;
            
            isDrawing = false;
            
            // Only create annotation if it has meaningful size (at least 20x20 pixels)
            if (currentAnnotation.width > 20 && currentAnnotation.height > 20) {
                // Remove temporary annotation
                clearTemporaryPdfAnnotation();
                
                // Create the permanent annotation element
                window.createPdfAnnotationElement(currentAnnotation);
                
                // Add to annotations array
                annotations.push(currentAnnotation);
                
                // Update annotations list
                window.updateAnnotationsList();
                
                showToast(`Annotation created! Total: ${annotations.length}`, 'success');
                console.log('Annotation created:', currentAnnotation);
            } else {
                // Remove temporary annotation if too small
                clearTemporaryPdfAnnotation();
                console.log('Annotation too small, discarded');
            }
            
            currentAnnotation = null;
        }

        // Render temporary annotation while drawing
        function renderTemporaryPdfAnnotation() {
            if (!currentAnnotation) return;
            
            // Remove any existing temporary annotation
            clearTemporaryPdfAnnotation();
            
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            if (!annotationLayer) return;
            
            // Create temporary annotation element
            const tempElement = document.createElement('div');
            tempElement.id = 'temp-pdf-annotation';
            tempElement.style.position = 'absolute';
            tempElement.style.left = currentAnnotation.x + 'px';
            tempElement.style.top = currentAnnotation.y + 'px';
            tempElement.style.width = currentAnnotation.width + 'px';
            tempElement.style.height = currentAnnotation.height + 'px';
            tempElement.style.border = `2px dashed ${currentAnnotation.color}`;
            tempElement.style.backgroundColor = `${currentAnnotation.color}20`;
            tempElement.style.pointerEvents = 'none';
            tempElement.style.zIndex = '5';
            
            annotationLayer.appendChild(tempElement);
        }

        // Clear temporary annotation
        function clearTemporaryPdfAnnotation() {
            const temp = document.getElementById('temp-pdf-annotation');
            if (temp) {
                temp.remove();
            }
        }

        // Create permanent PDF annotation element
        window.createPdfAnnotationElement = function(annotation) {
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            if (!annotationLayer) return;
            
            const annotationElement = document.createElement('div');
            annotationElement.className = 'pdf-annotation-box';
            annotationElement.id = `pdf-annotation-${annotation.id}`;
            annotationElement.style.position = 'absolute';
            annotationElement.style.left = annotation.x + 'px';
            annotationElement.style.top = annotation.y + 'px';
            annotationElement.style.width = annotation.width + 'px';
            annotationElement.style.height = annotation.height + 'px';
            annotationElement.style.border = `2px solid ${annotation.color}`;
            annotationElement.style.backgroundColor = `${annotation.color}10`;
            annotationElement.style.cursor = 'move';
            annotationElement.style.zIndex = '10';
            
            // Add text input for annotation
            const textInput = document.createElement('input');
            textInput.className = 'pdf-annotation-input';
            textInput.placeholder = 'Add note...';
            textInput.maxLength = 200;
            textInput.style.position = 'absolute';
            textInput.style.bottom = '-35px';
            textInput.style.left = '0';
            textInput.style.background = 'white';
            textInput.style.border = `2px solid ${annotation.color}`;
            textInput.style.borderRadius = '6px';
            textInput.style.padding = '4px 8px';
            textInput.style.fontSize = '12px';
            textInput.style.minWidth = '150px';
            textInput.style.outline = 'none';
            textInput.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
            textInput.style.zIndex = '20';
            
            // Handle text input
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    finishPdfTextInput(annotation, textInput, annotationElement);
                }
            });
            
            textInput.addEventListener('blur', () => {
                finishPdfTextInput(annotation, textInput, annotationElement);
            });
            
            // Add click event to re-edit text
            annotationElement.addEventListener('dblclick', () => {
                editPdfAnnotationText(annotation, annotationElement);
            });
            
            // Make annotation draggable
            setupPdfAnnotationDragging(annotationElement, annotation);
            
            annotationElement.appendChild(textInput);
            annotationLayer.appendChild(annotationElement);
            
            // Focus the input
            setTimeout(() => textInput.focus(), 50);
            
            console.log('Created PDF annotation element:', annotation.id);
        };

        // Handle finishing text input for PDF annotation
        function finishPdfTextInput(annotation, textInput, annotationElement) {
            const text = textInput.value.trim();
            annotation.text = text;
            
            textInput.remove();
            
            if (text) {
                const textDisplay = document.createElement('div');
                textDisplay.className = 'pdf-annotation-text';
                textDisplay.textContent = text;
                textDisplay.style.position = 'absolute';
                textDisplay.style.bottom = '-35px';
                textDisplay.style.left = '0';
                textDisplay.style.background = 'white';
                textDisplay.style.border = `1px solid ${annotation.color}`;
                textDisplay.style.borderRadius = '6px';
                textDisplay.style.padding = '4px 8px';
                textDisplay.style.fontSize = '12px';
                textDisplay.style.color = annotation.color;
                textDisplay.style.maxWidth = '200px';
                textDisplay.style.wordWrap = 'break-word';
                textDisplay.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
                textDisplay.style.pointerEvents = 'none';
                
                annotationElement.appendChild(textDisplay);
            }
            
            // Update annotations list
            window.updateAnnotationsList();
        }

        // Edit existing PDF annotation text
        function editPdfAnnotationText(annotation, annotationElement) {
            // Remove existing text display
            const existingText = annotationElement.querySelector('.pdf-annotation-text');
            if (existingText) {
                existingText.remove();
            }
            
            // Create new text input
            const textInput = document.createElement('input');
            textInput.className = 'pdf-annotation-input';
            textInput.value = annotation.text || '';
            textInput.placeholder = 'Add note...';
            textInput.maxLength = 200;
            textInput.style.position = 'absolute';
            textInput.style.bottom = '-35px';
            textInput.style.left = '0';
            textInput.style.background = 'white';
            textInput.style.border = `2px solid ${annotation.color}`;
            textInput.style.borderRadius = '6px';
            textInput.style.padding = '4px 8px';
            textInput.style.fontSize = '12px';
            textInput.style.minWidth = '150px';
            textInput.style.outline = 'none';
            textInput.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
            textInput.style.zIndex = '20';
            
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    finishPdfTextInput(annotation, textInput, annotationElement);
                }
            });
            
            textInput.addEventListener('blur', () => {
                finishPdfTextInput(annotation, textInput, annotationElement);
            });
            
            annotationElement.appendChild(textInput);
            textInput.focus();
            textInput.select();
        }

        // Setup dragging for PDF annotations
        function setupPdfAnnotationDragging(element, annotation) {
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            
            element.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('pdf-annotation-input')) return;
                
                isDragging = true;
                dragOffset.x = e.clientX - element.offsetLeft;
                dragOffset.y = e.clientY - element.offsetTop;
                element.classList.add('selected');
                e.preventDefault();
                e.stopPropagation();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const annotationLayer = document.getElementById('pdfAnnotationLayer');
                if (!annotationLayer) return;
                
                const layerRect = annotationLayer.getBoundingClientRect();
                const newLeft = e.clientX - layerRect.left - dragOffset.x;
                const newTop = e.clientY - layerRect.top - dragOffset.y;
                
                // Keep annotation within bounds
                const maxLeft = layerRect.width - element.offsetWidth;
                const maxTop = layerRect.height - element.offsetHeight;
                
                const constrainedLeft = Math.max(0, Math.min(maxLeft, newLeft));
                const constrainedTop = Math.max(0, Math.min(maxTop, newTop));
                
                element.style.left = constrainedLeft + 'px';
                element.style.top = constrainedTop + 'px';
                
                annotation.x = constrainedLeft;
                annotation.y = constrainedTop;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.classList.remove('selected');
                }
            });
        }

        // Navigate to specific page
        function navigateToPage(pageNumber) {
            if (pageNumber < 1 || pageNumber > totalPages) return;
            
            currentPageNumber = pageNumber;
            window.renderPdfPage(currentPageNumber);
            window.updatePageNavigation();
        }

        // PDF Annotation functionality - Define globally
        window.openPdfAnnotation = function() {
            console.log('openPdfAnnotation called');
            
            if (!originalPdfFile) {
                console.log('No original PDF file found');
                showToast('No PDF loaded. Please upload a PDF first.', 'error');
                return;
            }
            
            console.log('Original PDF file exists, reading fresh buffer...');
            showToast('Loading PDF for annotation...', 'success');
            
            // Read a fresh ArrayBuffer from the original file
            const reader = new FileReader();
            reader.onload = function(e) {
                const freshBuffer = e.target.result;
                pdfArrayBuffer = freshBuffer.slice(0); // Create a copy for annotation use
                
                try {
                    // Initialize PDF.js
                    if (typeof pdfjsLib === 'undefined') {
                        console.error('PDF.js library not loaded');
                        showToast('PDF.js library not loaded. Please refresh the page.', 'error');
                        return;
                    }
                    
                    console.log('PDF.js library found, setting worker...');
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    console.log('Loading PDF document for annotation...');
                    
                    // Load the PDF document with the fresh buffer
                    pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise.then(pdf => {
                        console.log('PDF loaded successfully for annotation, pages:', pdf.numPages);
                        pdfDocument = pdf;
                        totalPages = pdfDocument.numPages;
                        currentPageNumber = 1;
                        
                        // Initialize the modal
                        initializePdfAnnotationModal();
                        
                        // Render first page
                        window.renderPdfPage(currentPageNumber).then(() => {
                            console.log('First page rendered, showing modal...');
                            // Show the modal
                            const modal = document.getElementById('pdfAnnotationModal');
                            if (modal) {
                                modal.classList.add('active');
                                window.updatePageNavigation();
                                showToast('PDF ready for annotation!', 'success');
                                console.log('Modal should be visible now');
                            } else {
                                console.error('PDF annotation modal not found!');
                            }
                        }).catch(error => {
                            console.error('Error rendering first page:', error);
                            showToast('Error rendering PDF page.', 'error');
                        });
                    }).catch(error => {
                        console.error('Error loading PDF for annotation:', error);
                        showToast('Failed to load PDF for annotation. Please try again.', 'error');
                    });
                    
                } catch (error) {
                    console.error('Error in openPdfAnnotation:', error);
                    showToast('Failed to initialize PDF annotation. Please try again.', 'error');
                }
            };
            
            reader.onerror = function() {
                console.error('Error reading PDF file for annotation');
                showToast('Error reading PDF file for annotation.', 'error');
            };
            
            reader.readAsArrayBuffer(originalPdfFile);
        };

        window.resetPdfAnnotationState = function() {
            annotations = [];
            isAnnotationMode = false;
            currentAnnotation = null;
            isDrawing = false;
            isDraggingAnnotation = false;
            pdfZoom = 1.0;
            
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            if (annotationLayer) {
                annotationLayer.innerHTML = '';
                annotationLayer.classList.remove('active');
            }
            
            const toggleBtn = document.getElementById('annotationModeToggle');
            if (toggleBtn) {
                toggleBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-width="2"/>
                </svg>Start Annotating`;
                toggleBtn.classList.remove('active');
            }
            
            window.updateAnnotationsList();
            window.updateZoomDisplay();
        };

        window.renderPdfPage = async function(pageNumber) {
            if (!pdfDocument) {
                console.error('No PDF document loaded');
                return;
            }
            
            try {
                const page = await pdfDocument.getPage(pageNumber);
                const canvas = document.getElementById('pdfCanvas');
                const context = canvas.getContext('2d');
                
                if (!canvas || !context) {
                    console.error('Canvas element not found');
                    return;
                }
                
                // Calculate viewport with zoom
                const viewport = page.getViewport({ scale: pdfZoom });
                
                // Set canvas size
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';
                
                // Clear previous render
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                // Render PDF page
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                // Update annotation layer size
                const annotationLayer = document.getElementById('pdfAnnotationLayer');
                if (annotationLayer) {
                    annotationLayer.style.width = viewport.width + 'px';
                    annotationLayer.style.height = viewport.height + 'px';
                }
                
                // Render annotations for this page
                window.renderPageAnnotations(pageNumber);
                
                console.log(`Rendered page ${pageNumber} of ${totalPages}`);
                
            } catch (error) {
                console.error('Error rendering PDF page:', error);
                showToast('Error rendering PDF page.', 'error');
            }
        };

        window.updatePageNavigation = function() {
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentPageNumber} of ${totalPages}`;
            }
            
            if (prevBtn) {
                prevBtn.disabled = currentPageNumber <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentPageNumber >= totalPages;
            }
        };

        window.updateZoomDisplay = function() {
            const zoomDisplay = document.getElementById('zoomDisplay');
            if (zoomDisplay) {
                zoomDisplay.textContent = Math.round(pdfZoom * 100) + '%';
            }
        };

        window.updateAnnotationsList = function() {
            const annotationsList = document.getElementById('annotationsList');
            if (!annotationsList) return;
            
            if (annotations.length === 0) {
                annotationsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        <p>No annotations yet</p>
                        <p class="text-xs mt-1">Start annotating to see them here</p>
                    </div>
                `;
                return;
            }
            
            const annotationsHtml = annotations.map((annotation, index) => `
                <div class="annotation-list-item" onclick="window.jumpToAnnotation(${index})">
                    <div class="annotation-page-badge">Page ${annotation.page}</div>
                    <div class="annotation-text-preview">
                        <span class="annotation-color-indicator" style="background: ${annotation.color};"></span>
                        ${annotation.text || 'No description'}
                    </div>
                </div>
            `).join('');
            
            annotationsList.innerHTML = annotationsHtml;
        };

        window.renderPageAnnotations = function(pageNumber) {
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            if (!annotationLayer) return;
            
            annotationLayer.innerHTML = '';
            
            const pageAnnotations = annotations.filter(ann => ann.page === pageNumber);
            
            pageAnnotations.forEach(annotation => {
                window.createPdfAnnotationElement(annotation);
            });
        };

        // Color picker initialization
        function initializeColorPicker() {
            // Color picker initialization
            const customColorInput = document.getElementById('customColorInput');
            if (customColorInput) {
                customColorInput.addEventListener('change', (e) => {
                    currentAnnotationColor = e.target.value;
                    updateColorSelection();
                });
            }
            
            // Color options
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    currentAnnotationColor = e.target.dataset.color;
                    updateColorSelection();
                    
                    if (customColorInput) {
                        customColorInput.value = currentAnnotationColor;
                    }
                    
                    console.log('Color changed to:', currentAnnotationColor);
                });
            });
            
            // Initialize with default color
            updateColorSelection();
        }

        // Make sure to call this when the PDF annotation modal opens
        function initializePdfAnnotationModal() {
            // Reset annotation state
            window.resetPdfAnnotationState();
            
            // Initialize color picker
            initializeColorPicker();
            
            // Set up event listeners for modal-specific controls
            const annotationModeToggle = document.getElementById('annotationModeToggle');
            if (annotationModeToggle) {
                // Remove existing listeners to prevent duplicates
                annotationModeToggle.replaceWith(annotationModeToggle.cloneNode(true));
                const newToggle = document.getElementById('annotationModeToggle');
                newToggle.addEventListener('click', window.togglePdfAnnotationMode);
            }
        }

        // Export functions - make them global
        window.exportAnnotatedPdf = async function() {
            if (!originalPdfFile || annotations.length === 0) {
                showToast('No annotations to export', 'error');
                return;
            }
            
            try {
                showToast('Generating annotated PDF...', 'success');
                
                if (typeof PDFLib === 'undefined') {
                    showToast('PDF-lib library not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                // Read a fresh ArrayBuffer from the original file for PDF-lib
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const freshBuffer = e.target.result;
                        
                        // Load PDF with PDF-lib
                        const pdfDoc = await PDFLib.PDFDocument.load(freshBuffer);
                        const pages = pdfDoc.getPages();
                        
                        // Group annotations by page
                        const annotationsByPage = {};
                        annotations.forEach(annotation => {
                            if (!annotationsByPage[annotation.page]) {
                                annotationsByPage[annotation.page] = [];
                            }
                            annotationsByPage[annotation.page].push(annotation);
                        });
                        
                        // Add annotations to each page
                        Object.entries(annotationsByPage).forEach(([pageNumber, pageAnnotations]) => {
                            const page = pages[pageNumber - 1];
                            if (!page) return;
                            
                            const { width, height } = page.getSize();
                            
                            pageAnnotations.forEach(annotation => {
                                // Scale annotation coordinates to PDF coordinate system
                                const scaleX = width / (pdfZoom * width);
                                const scaleY = height / (pdfZoom * height);
                                
                                const x = annotation.x * scaleX;
                                const y = height - (annotation.y * scaleY) - (annotation.height * scaleY);
                                const w = annotation.width * scaleX;
                                const h = annotation.height * scaleY;
                                
                                // Draw rectangle
                                page.drawRectangle({
                                    x: x,
                                    y: y,
                                    width: w,
                                    height: h,
                                    borderColor: PDFLib.rgb(
                                        parseInt(annotation.color.slice(1, 3), 16) / 255,
                                        parseInt(annotation.color.slice(3, 5), 16) / 255,
                                        parseInt(annotation.color.slice(5, 7), 16) / 255
                                    ),
                                    borderWidth: 2,
                                    opacity: 0.8
                                });
                                
                                // Add text if exists
                                if (annotation.text) {
                                    page.drawText(annotation.text, {
                                        x: x + 5,
                                        y: y - 15,
                                        size: 10,
                                        color: PDFLib.rgb(
                                            parseInt(annotation.color.slice(1, 3), 16) / 255,
                                            parseInt(annotation.color.slice(3, 5), 16) / 255,
                                            parseInt(annotation.color.slice(5, 7), 16) / 255
                                        )
                                    });
                                }
                            });
                        });
                        
                        // Save the PDF
                        const pdfBytes = await pdfDoc.save();
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        const fileName = document.getElementById('pdfFileName');
                        link.download = `annotated-${fileName ? fileName.textContent : 'document'}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        showToast('Annotated PDF exported successfully!', 'success');
                        
                    } catch (error) {
                        console.error('Error exporting annotated PDF:', error);
                        showToast('Failed to export annotated PDF', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Error reading PDF file for export.', 'error');
                };
                
                reader.readAsArrayBuffer(originalPdfFile);
                
            } catch (error) {
                console.error('Error exporting annotated PDF:', error);
                showToast('Failed to export annotated PDF', 'error');
            }
        };

        window.exportAnnotationReport = function() {
            if (annotations.length === 0) {
                showToast('No annotations to export', 'error');
                return;
            }
            
            let csv = 'Page,X,Y,Width,Height,Color,Text,Timestamp,Device Context\n';
            
            annotations.forEach(annotation => {
                const deviceContext = `${currentDevice.name} (${currentDevice.width}x${currentDevice.height})`;
                csv += [
                    annotation.page,
                    annotation.x,
                    annotation.y,
                    annotation.width,
                    annotation.height,
                    annotation.color,
                    `"${(annotation.text || '').replace(/"/g, '""')}"`,
                    annotation.timestamp,
                    `"${deviceContext}"`
                ].join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pdf-annotations-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Annotation report exported successfully!', 'success');
        };

        window.closePdfAnnotationModal = function() {
            const modal = document.getElementById('pdfAnnotationModal');
            if (modal) {
                modal.classList.remove('active');
            }
            
            window.resetPdfAnnotationState();
            
            // Clean up PDF document
            if (pdfDocument) {
                pdfDocument.destroy();
                pdfDocument = null;
            }
        };

        window.togglePdfAnnotationMode = function() {
            isAnnotationMode = !isAnnotationMode;
            const toggleBtn = document.getElementById('annotationModeToggle');
            const annotationLayer = document.getElementById('pdfAnnotationLayer');
            
            if (!toggleBtn || !annotationLayer) {
                console.error('Required elements not found for annotation mode toggle');
                return;
            }
            
            if (isAnnotationMode) {
                toggleBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="20,6 9,17 4,12" stroke-width="2"/>
                </svg>Stop Annotating`;
                toggleBtn.classList.add('active');
                annotationLayer.classList.add('active');
                setupPdfAnnotationEvents();
                showToast('Click and drag to create annotations', 'success');
            } else {
                toggleBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-width="2"/>
                </svg>Start Annotating`;
                toggleBtn.classList.remove('active');
                annotationLayer.classList.remove('active');
                removePdfAnnotationEvents();
            }
        };

        window.jumpToAnnotation = function(index) {
            const annotation = annotations[index];
            if (!annotation) return;
            
            if (annotation.page !== currentPageNumber) {
                navigateToPage(annotation.page);
            }
            
            // Highlight the annotation briefly
            setTimeout(() => {
                const element = document.getElementById(`pdf-annotation-${annotation.id}`);
                if (element) {
                    element.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.8)';
                    setTimeout(() => {
                        element.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
                    }, 2000);
                }
            }, 100);
        };

        window.rotateDevice = function(index) {
            event.stopPropagation();
            const miniTablet = document.getElementById(`mini-tablet-${index}`);
            if (miniTablet) {
                miniTablet.classList.toggle('landscape');
            }
        };

        function updateColorSelection() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.color === currentAnnotationColor) {
                    option.classList.add('active');
                }
            });
        }

        // Store the original file for re-reading when needed
        let originalPdfFile = null;

        // File handling with enhanced analysis
        function handleFile(file) {
            if (!file) return;
            
            const isPDF = file.type === 'application/pdf' || 
                         file.type === 'application/x-pdf' || 
                         file.name.toLowerCase().endsWith('.pdf');
            
            if (!isPDF) {
                showToast('Please upload a valid PDF file.', 'error');
                return;
            }

            // Store the original file for later use
            originalPdfFile = file;
            fileSize = file.size;
            showLoadingScreen();

            if (currentPdfUrl) {
                URL.revokeObjectURL(currentPdfUrl);
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    // Store PDF data - create a copy for analysis
                    const originalBuffer = e.target.result;
                    const analysisBuffer = originalBuffer.slice(0);
                    
                    // Create URL for iframe viewer
                    currentPdfUrl = URL.createObjectURL(file);
                    document.getElementById('pdfName').textContent = file.name;
                    document.getElementById('pdfFileName').textContent = file.name;

                    // Start PDF analysis using the copy
                    console.log('Starting PDF analysis...');
                    pdfAnalysis = await analyzePDF(analysisBuffer);
                    console.log('PDF analysis complete:', pdfAnalysis);

                    // Update iframe viewer
                    const mainPdfViewer = document.getElementById('mainPdfViewer');
                    mainPdfViewer.src = currentPdfUrl + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH';

                    setTimeout(() => {
                        showPreviewScreen();
                        updatePdfAnalysisDisplay();
                        analyzeCompatibility();
                        generateEnhancedRecommendations();
                        showToast('PDF analysis completed!', 'success');
                    }, 3000);
                } catch (error) {
                    console.error('Error processing PDF:', error);
                    showToast('Error analyzing PDF. Using basic compatibility mode.', 'error');
                    // Continue with basic analysis
                    pdfAnalysis = {};
                    setTimeout(() => {
                        showPreviewScreen();
                        updatePdfAnalysisDisplay();
                        analyzeCompatibility();
                        generateEnhancedRecommendations();
                    }, 2000);
                }
            };
            
            reader.onerror = function() {
                showToast('Error reading PDF file.', 'error');
                resetToUpload();
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Device compatibility analysis
        function analyzeCompatibility() {
            const deviceGrid = document.getElementById('deviceGrid');
            deviceGrid.innerHTML = '';
            deviceCompatibilities = [];
            let excellentCount = 0;
            let goodCount = 0;
            let issuesCount = 0;

            tablets.forEach((tablet, index) => {
                const compatibility = calculateEnhancedCompatibility(tablet);
                deviceCompatibilities[index] = compatibility;
                const deviceCard = createEnhancedDeviceCard(tablet, compatibility, index);
                deviceGrid.appendChild(deviceCard);

                if (compatibility.status === 'excellent') excellentCount++;
                else if (compatibility.status === 'good') goodCount++;
                else issuesCount++;
            });

            document.getElementById('excellentCount').textContent = excellentCount;
            document.getElementById('goodCount').textContent = goodCount;
            document.getElementById('issuesCount').textContent = issuesCount;
        }

        function createEnhancedDeviceCard(tablet, compatibility, index) {
            const card = document.createElement('div');
            card.className = 'device-card';
            if (index === currentDeviceIndex) card.classList.add('selected');
            
            const statusClass = compatibility.status === 'excellent' ? 'success' : 
                               compatibility.status === 'good' ? 'warning' : 'error';
            
            const perfClass = compatibility.performanceScore >= 8 ? 'fast' :
                             compatibility.performanceScore >= 5 ? 'moderate' : 'slow';
            
            // Create detailed tooltip with PDF-specific information
            const tooltipContent = compatibility.averageTextSize ? 
                `${compatibility.message}
                
                Performance: ${compatibility.performanceScore}/10
                Text Size: ${Math.round(compatibility.averageTextSize)}pt avg
                Scale Factor: ${Math.round(compatibility.scaleFactor * 100)}%
                ${compatibility.issues && compatibility.issues.length > 0 ? `
                Issues: ${compatibility.issues.slice(0, 2).join(', ')}` : ''}` :
                compatibility.message;
            
            card.innerHTML = `
                <div class="mini-tablet" id="mini-tablet-${index}">
                    <div class="mini-tablet-screen"></div>
                </div>
                <button class="rotate-button" onclick="rotateDevice(${index})">↻</button>
                <div class="device-name">${tablet.name}</div>
                <div class="device-specs">${tablet.width} × ${tablet.height} • ${tablet.ram}GB RAM</div>
                <div class="device-status">
                    <span class="indicator indicator-${statusClass}"></span>
                    <span>${compatibility.status.charAt(0).toUpperCase() + compatibility.status.slice(1)}</span>
                </div>
                <div class="performance-badge performance-${perfClass}">
                    ${perfClass === 'fast' ? '⚡' : perfClass === 'moderate' ? '🔋' : '🐌'} 
                    ${compatibility.overallScore || compatibility.performanceScore}/10
                </div>
                <div class="tooltip">
                    ${tooltipContent}
                </div>
            `;
            
            card.addEventListener('click', () => selectDevice(index));
            
            return card;
        }

        function selectDevice(index) {
            document.querySelectorAll('.device-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.device-card')[index].classList.add('selected');
            
            document.getElementById('deviceSelector').value = index;
            currentDeviceIndex = index;
            currentDevice = tablets[index];
            updateMainPreview();
            generateEnhancedRecommendations();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Tablet Tester with Annotations initializing...');
            
            // Add roundRect polyfill for older browsers
            if (!CanvasRenderingContext2D.prototype.roundRect) {
                CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                    this.beginPath();
                    this.moveTo(x + radius, y);
                    this.lineTo(x + width - radius, y);
                    this.quadraticCurveTo(x + width, y, x + width, y + radius);
                    this.lineTo(x + width, y + height - radius);
                    this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                    this.lineTo(x + radius, y + height);
                    this.quadraticCurveTo(x, y + height, x, y + height - radius);
                    this.lineTo(x, y + radius);
                    this.quadraticCurveTo(x, y, x + radius, y);
                    this.closePath();
                };
            }
            
            initializeEventListeners();
            initializeDeviceSelector();
            
            // Add a small delay to ensure all elements are loaded, then initialize color picker
            setTimeout(initializeColorPicker, 100);
        });

        function initializeEventListeners() {
            // File upload handlers
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const browseButton = document.getElementById('browseButton');
            
            if (browseButton && fileInput) {
                browseButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                });
            }
            
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFile(files[0]);
                    }
                });
            }
            
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files && files.length > 0) {
                        handleFile(files[0]);
                    }
                });
            }
            
            // Main controls with direct function references
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', resetToUpload);
            }
            
            const rotateMainBtn = document.getElementById('rotateMainBtn');
            if (rotateMainBtn) {
                rotateMainBtn.addEventListener('click', toggleMainOrientation);
            }
            
            const annotateBtn = document.getElementById('annotateBtn');
            if (annotateBtn) {
                console.log('Attaching click listener to annotate button');
                annotateBtn.addEventListener('click', function(e) {
                    console.log('Annotate button clicked!');
                    e.preventDefault();
                    window.openPdfAnnotation();
                });
            } else {
                console.error('Annotate button not found!');
            }
            
            const exportAllBtn = document.getElementById('exportAllBtn');
            if (exportAllBtn) {
                exportAllBtn.addEventListener('click', exportAllDevices);
            }
            
            const exportReportBtn = document.getElementById('exportReportBtn');
            if (exportReportBtn) {
                exportReportBtn.addEventListener('click', exportEnhancedReport);
            }
            
            // Device selector
            const deviceSelector = document.getElementById('deviceSelector');
            if (deviceSelector) {
                deviceSelector.addEventListener('change', (e) => {
                    currentDeviceIndex = parseInt(e.target.value);
                    currentDevice = tablets[currentDeviceIndex];
                    updateMainPreview();
                    generateEnhancedRecommendations();
                });
            }
            
            // Zoom controls
            const zoomSlider = document.getElementById('zoomSlider');
            if (zoomSlider) {
                zoomSlider.addEventListener('input', handleZoomChange);
            }
            
            const zoomIn = document.getElementById('zoomIn');
            if (zoomIn) {
                zoomIn.addEventListener('click', () => zoomBy(10));
            }
            
            const zoomOut = document.getElementById('zoomOut');
            if (zoomOut) {
                zoomOut.addEventListener('click', () => zoomBy(-10));
            }
            
            const resetZoom = document.getElementById('resetZoom');
            if (resetZoom) {
                resetZoom.addEventListener('click', resetZoomHandler);
            }
            
            // Pan controls
            const pdfContainer = document.getElementById('pdfContainer');
            if (pdfContainer) {
                pdfContainer.addEventListener('mousedown', startPan);
                pdfContainer.addEventListener('mousemove', doPan);
                pdfContainer.addEventListener('mouseup', endPan);
                pdfContainer.addEventListener('mouseleave', endPan);
            }
            
            // PDF Annotation Modal controls
            const clearAllPdfAnnotations = document.getElementById('clearAllPdfAnnotations');
            if (clearAllPdfAnnotations) {
                clearAllPdfAnnotations.addEventListener('click', function() {
                    annotations = [];
                    window.renderPageAnnotations(currentPageNumber);
                    window.updateAnnotationsList();
                    showToast('All annotations cleared', 'success');
                });
            }
            
            const exportPdfWithAnnotations = document.getElementById('exportPdfWithAnnotations');
            if (exportPdfWithAnnotations) {
                exportPdfWithAnnotations.addEventListener('click', window.exportAnnotatedPdf);
            }
            
            const exportAnnotationReport = document.getElementById('exportAnnotationReport');
            if (exportAnnotationReport) {
                exportAnnotationReport.addEventListener('click', window.exportAnnotationReport);
            }
            
            const closePdfAnnotationBtn = document.getElementById('closePdfAnnotationBtn');
            if (closePdfAnnotationBtn) {
                closePdfAnnotationBtn.addEventListener('click', window.closePdfAnnotationModal);
            }
            
            const closePdfModal = document.getElementById('closePdfModal');
            if (closePdfModal) {
                closePdfModal.addEventListener('click', window.closePdfAnnotationModal);
            }
            
            // PDF Navigation controls
            const prevPageBtn = document.getElementById('prevPageBtn');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (currentPageNumber > 1) {
                        currentPageNumber--;
                        window.renderPdfPage(currentPageNumber);
                        window.updatePageNavigation();
                    }
                });
            }
            
            const nextPageBtn = document.getElementById('nextPageBtn');
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    if (currentPageNumber < totalPages) {
                        currentPageNumber++;
                        window.renderPdfPage(currentPageNumber);
                        window.updatePageNavigation();
                    }
                });
            }
            
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', function() {
                    pdfZoom = Math.max(0.5, pdfZoom - 0.2);
                    window.renderPdfPage(currentPageNumber);
                    window.updateZoomDisplay();
                });
            }
            
            const zoomInBtn = document.getElementById('zoomInBtn');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', function() {
                    pdfZoom = Math.min(3.0, pdfZoom + 0.2);
                    window.renderPdfPage(currentPageNumber);
                    window.updateZoomDisplay();
                });
            }
            
            const resetZoomBtn = document.getElementById('resetZoomBtn');
            if (resetZoomBtn) {
                resetZoomBtn.addEventListener('click', function() {
                    pdfZoom = 1.0;
                    window.renderPdfPage(currentPageNumber);
                    window.updateZoomDisplay();
                });
            }
            
            // Summary filters
            document.querySelectorAll('.summary-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const filter = e.currentTarget.dataset.filter;
                    setActiveFilter(filter);
                });
            });
        }

        // Loading screen management
        function showLoadingScreen() {
            document.getElementById('uploadScreen').classList.remove('active');
            document.getElementById('loadingScreen').classList.add('active');
            
            let messageIndex = 0;
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.textContent = loadingMessages[0];
            
            const messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % loadingMessages.length;
                loadingMessage.textContent = loadingMessages[messageIndex];
            }, 400);
            
            document.getElementById('loadingScreen').messageInterval = messageInterval;
        }

        function showPreviewScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen.messageInterval) {
                clearInterval(loadingScreen.messageInterval);
            }
            
            loadingScreen.classList.remove('active');
            document.getElementById('previewScreen').classList.add('active');
            updateMainPreview();
        }

        // Main preview functions
        function toggleMainOrientation() {
            isPortrait = !isPortrait;
            updateMainPreview();
        }

        function updateMainPreview() {
            const device = currentDevice;
            const scale = device.scale || 0.8;
            const isMobile = window.innerWidth < 768;
            const mobileScale = 0.6;
            
            let width, height;
            if (isPortrait) {
                width = device.width * scale * (isMobile ? mobileScale : 1);
                height = device.height * scale * (isMobile ? mobileScale : 1);
            } else {
                width = device.height * scale * (isMobile ? mobileScale : 1);
                height = device.width * scale * (isMobile ? mobileScale : 1);
            }
            
            const maxWidth = isMobile ? window.innerWidth - 40 : 700;
            const maxHeight = isMobile ? 400 : 500;
            
            if (width > maxWidth || height > maxHeight) {
                const scaleDown = Math.min(maxWidth / width, maxHeight / height);
                width *= scaleDown;
                height *= scaleDown;
            }
            
            const mainTablet = document.getElementById('mainTablet');
            mainTablet.style.width = width + 'px';
            mainTablet.style.height = height + 'px';
            
            const mainTabletContainer = document.getElementById('mainTabletContainer');
            const containerHeight = height + 100;
            mainTabletContainer.style.minHeight = containerHeight + 'px';
        }

        function initializeDeviceSelector() {
            const deviceSelector = document.getElementById('deviceSelector');
            if (!deviceSelector) return;
            
            deviceSelector.innerHTML = '';
            tablets.forEach((tablet, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${tablet.brand} ${tablet.name}`;
                deviceSelector.appendChild(option);
            });
        }

        // Pan and zoom functions
        function startPan(e) {
            if (isAnnotationMode) return;
            isDragging = true;
            dragStartX = e.clientX - panX;
            dragStartY = e.clientY - panY;
            e.currentTarget.classList.add('grabbing');
        }

        function doPan(e) {
            if (!isDragging) return;
            e.preventDefault();
            panX = e.clientX - dragStartX;
            panY = e.clientY - dragStartY;
            updateTransform();
        }

        function endPan(e) {
            isDragging = false;
            e.currentTarget.classList.remove('grabbing');
        }

        function handleZoomChange() {
            currentZoom = parseInt(document.getElementById('zoomSlider').value);
            updateZoomDisplay();
            updateTransform();
        }

        function zoomBy(delta) {
            const zoomSlider = document.getElementById('zoomSlider');
            zoomSlider.value = Math.min(200, Math.max(50, currentZoom + delta));
            handleZoomChange();
        }

        function resetZoomHandler() {
            const zoomSlider = document.getElementById('zoomSlider');
            zoomSlider.value = 100;
            currentZoom = 100;
            handleZoomChange();
            panX = 0;
            panY = 0;
            updateTransform();
        }

        function updateZoomDisplay() {
            const zoomPercentage = document.getElementById('zoomPercentage');
            zoomPercentage.textContent = currentZoom + '%';
            
            if (currentZoom > 150) {
                zoomPercentage.classList.add('warning');
            } else {
                zoomPercentage.classList.remove('warning');
            }
        }

        function updateTransform() {
            const mainPdfViewer = document.getElementById('mainPdfViewer');
            mainPdfViewer.style.transform = `scale(${currentZoom / 100}) translate(${panX}px, ${panY}px)`;
        }

        function setActiveFilter(filter) {
            activeFilter = filter;
            
            document.querySelectorAll('.summary-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.filter === filter) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.device-card').forEach((card, index) => {
                const compat = deviceCompatibilities[index];
                if (filter === 'all' || 
                    (filter === 'excellent' && compat.status === 'excellent') ||
                    (filter === 'good' && compat.status === 'good') ||
                    (filter === 'issues' && compat.status === 'issues')) {
                    card.classList.remove('filtered-out');
                } else {
                    card.classList.add('filtered-out');
                }
            });
        }

        // Export functions
        function exportAllDevices() {
            showToast('This feature would capture screenshots of your PDF on all 25 devices and compile them into a downloadable package.', 'success');
        }

        // Enhanced export function with real analysis data
        function exportEnhancedReport() {
            if (!deviceCompatibilities || deviceCompatibilities.length === 0) {
                showToast('Please wait for the analysis to complete before exporting.', 'error');
                return;
            }
            
            let csv = 'Device,Brand,Resolution,PPI,RAM,Performance,Compatibility,Overall Score,Text Size (pt),Scale Factor,Specific Issues,Detailed Recommendations\n';
            
            tablets.forEach((tablet, index) => {
                const compat = deviceCompatibilities[index];
                
                if (!compat) return;
                
                const issues = compat.issues ? compat.issues.join('; ') : 'None';
                const textSize = compat.averageTextSize ? Math.round(compat.averageTextSize) : 'N/A';
                const scaleFactor = compat.scaleFactor ? Math.round(compat.scaleFactor * 100) + '%' : 'N/A';
                
                const escapeCsvField = (field) => {
                    if (field === null || field === undefined) return '';
                    field = String(field);
                    if (field.includes(',') || field.includes('"') || field.includes('\n') || field.includes('\r') || field.includes(';')) {
                        return '"' + field.replace(/"/g, '""') + '"';
                    }
                    return field;
                };
                
                csv += [
                    escapeCsvField(tablet.name),
                    escapeCsvField(tablet.brand),
                    escapeCsvField(`${tablet.width}x${tablet.height}`),
                    escapeCsvField(tablet.ppi),
                    escapeCsvField(`${tablet.ram}GB`),
                    escapeCsvField(tablet.performance),
                    escapeCsvField(compat.status),
                    escapeCsvField(compat.overallScore || compat.performanceScore),
                    escapeCsvField(textSize),
                    escapeCsvField(scaleFactor),
                    escapeCsvField(issues),
                    escapeCsvField(compat.message)
                ].join(',') + '\n';
            });
            
            // Add PDF analysis summary at the end
            csv += '\n\nPDF Analysis Summary:\n';
            csv += `File Name,${escapeCsvField(document.getElementById('pdfName').textContent)}\n`;
            csv += `File Size (MB),${(fileSize / (1024 * 1024)).toFixed(2)}\n`;
            if (pdfAnalysis && Object.keys(pdfAnalysis).length > 0) {
                csv += `Page Count,${pdfAnalysis.pageCount}\n`;
                csv += `Dimensions,${Math.round(pdfDimensions.width)}x${Math.round(pdfDimensions.height)}\n`;
                csv += `Complexity Score,${Math.round(pdfAnalysis.complexityScore)}/100\n`;
                csv += `Average Font Size,${pdfAnalysis.averageFontSize ? pdfAnalysis.averageFontSize.toFixed(1) + 'pt' : 'N/A'}\n`;
                csv += `Min Font Size,${pdfAnalysis.minFontSize ? pdfAnalysis.minFontSize.toFixed(1) + 'pt' : 'N/A'}\n`;
                csv += `Text Content Length,${pdfAnalysis.totalTextLength}\n`;
                csv += `Number of Images,${pdfAnalysis.totalImages}\n`;
                csv += `Has Interactive Elements,${pdfAnalysis.hasInteractiveElements ? 'Yes' : 'No'}\n`;
                csv += `Has Complex Graphics,${pdfAnalysis.hasComplexGraphics ? 'Yes' : 'No'}\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `enhanced-tablet-analysis-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Enhanced analysis report exported successfully!', 'success');
        }

        // Utility functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function resetToUpload() {
            document.getElementById('previewScreen').classList.remove('active');
            document.getElementById('uploadScreen').classList.add('active');
            
            if (currentPdfUrl) {
                URL.revokeObjectURL(currentPdfUrl);
                currentPdfUrl = null;
            }
            
            document.getElementById('fileInput').value = '';
            document.getElementById('mainPdfViewer').src = '';
            currentZoom = 100;
            panX = 0;
            panY = 0;
            isPortrait = true;
            currentDeviceIndex = 0;
            currentDevice = tablets[0];
            activeFilter = 'all';
            pdfAnalysis = {};
            pdfDimensions = { width: 612, height: 792 };
            annotations = [];
            
            showToast('Ready for new PDF upload', 'success');
        }

        // Make functions globally available
        window.setupPdfAnnotationEvents = setupPdfAnnotationEvents;
        window.removePdfAnnotationEvents = removePdfAnnotationEvents;
        window.startPdfAnnotation = startPdfAnnotation;
        window.drawPdfAnnotation = drawPdfAnnotation;
        window.finishPdfAnnotation = finishPdfAnnotation;
        window.showToast = showToast;
        window.updateColorSelection = updateColorSelection;

        // Window resize handler
        window.addEventListener('resize', () => {
            if (document.getElementById('previewScreen').classList.contains('active')) {
                updateMainPreview();
            }
            
            // Also update PDF annotation layer if modal is open
            if (document.getElementById('pdfAnnotationModal').classList.contains('active') && pdfDocument) {
                setTimeout(() => {
                    const annotationLayer = document.getElementById('pdfAnnotationLayer');
                    const canvas = document.getElementById('pdfCanvas');
                    if (canvas && annotationLayer) {
                        annotationLayer.style.width = canvas.style.width;
                        annotationLayer.style.height = canvas.style.height;
                    }
                }, 100);
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentPdfUrl) {
                URL.revokeObjectURL(currentPdfUrl);
            }
            
            if (pdfDocument) {
                pdfDocument.destroy();
            }
        });
    </script>
</body>
</html>
                                
